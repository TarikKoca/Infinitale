{% extends "base.html" %}
{% load static %}
{% load i18n %}
{% block title %}{% trans "Sign Up" %} - Eternalore{% endblock %}
{% block head %}
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">
  <style>
    .bg-hero-register { background-image: url("{% static 'images/hero_bg_others.png' %}"); }
  </style>
{% endblock %}
{% block content %}
<div class="bg-gray-900 overflow-x-hidden max-w-full m-0">
  <div class="fixed inset-0 bg-cover bg-center bg-fixed backdrop-blur-2xl bg-hero-register">
    <div class="absolute inset-0 bg-gradient-to-br from-gray-900/80 via-black/70 to-gray-800/80"></div>
  </div>
  <main class="relative z-30 min-h-screen flex items-center justify-center px-4 py-8">
    <div class="auth-container">
      <div class="auth-card">
        <div class="text-center mb-6">
          <img src="{% static 'images/logo.png' %}" class="h-16 w-16 mx-auto landing-logo" alt="Eternalore">
          <h1 class="auth-title mt-4">{% trans "Create your account" %}</h1>
          <p class="auth-subtitle">{% trans "Join and start your adventure" %}</p>
        </div>
        {% if messages %}
          <div class="form-message error">
            {% for m in messages %}
              <div>{{ m }}</div>
            {% endfor %}
          </div>
        {% endif %}
        <form id="registerForm" method="post" action="">
          {% csrf_token %}
          <!-- Nickname removed: we derive display name from email local-part -->
          <div class="form-group">
            <label class="form-label">{% trans "Email" %}</label>
            <input type="email" name="email" class="form-input" placeholder="you@example.com" required>
          </div>
          <div class="form-group input-with-icon">
            <label class="form-label">{% trans "Password" %}</label>
            <input id="password" type="password" name="password" class="form-input" placeholder="Create a strong password" required minlength="8">
            <button type="button" id="togglePassword" class="input-icon-button" aria-label="{% trans "Toggle password visibility" %}">
              <i class="fa-solid fa-eye" id="eye"></i>
            </button>
            <div id="password-strength" class="mt-2">
              <div class="flex space-x-1 mb-1">
                <div class="pw-bar h-1 bg-gray-600 rounded-full flex-1"></div>
                <div class="pw-bar h-1 bg-gray-600 rounded-full flex-1"></div>
                <div class="pw-bar h-1 bg-gray-600 rounded-full flex-1"></div>
                <div class="pw-bar h-1 bg-gray-600 rounded-full flex-1"></div>
              </div>
              <p id="pwHelp" class="text-xs text-gray-300">{% trans "Use 8+ chars with letters, numbers, symbols" %}</p>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">{% trans "Confirm Password" %}</label>
            <div class="input-with-icon">
              <input id="password2" type="password" name="confirmPassword" class="form-input" placeholder="••••••••" required>
              <button type="button" id="togglePassword2" class="input-icon-button" aria-label="{% trans "Toggle confirm password visibility" %}">
                <i class="fa-solid fa-eye" id="eye2"></i>
              </button>
            </div>
          </div>
          <div class="form-group" style="margin-bottom: 1rem;">
            <div class="flex items-start gap-2">
              <input id="acceptTerms" name="acceptTerms" type="checkbox" class="mt-1" required>
              {% url 'terms' as terms_url %}
              {% url 'privacy' as privacy_url %}
              <label for="acceptTerms" class="text-sm text-gray-300">{% blocktrans trimmed %}I agree to the <a href="{{ terms_url }}" class="underline">Terms</a> and <a href="{{ privacy_url }}" class="underline">Privacy Policy</a>.{% endblocktrans %}</label>
            </div>
          </div>
          <button type="submit" class="btn btn-primary btn-block">{% trans "Create Account" %}</button>
        </form>
        <div class="auth-divider"><span>{% trans "Or sign up with" %}</span></div>
        <a href="/accounts/google/login/" class="btn btn-google btn-block" aria-label="{% trans "Continue with Google" %}">
          <svg class="w-5 h-5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
            <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
            <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
            <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
          </svg>
          <span>{% trans "Continue with Google" %}</span>
        </a>
        <script>
          (function(){
            // i18n strings for JS
            var T_VERY_WEAK = "{% filter escapejs %}{% trans 'Very weak' %}{% endfilter %}";
            var T_WEAK = "{% filter escapejs %}{% trans 'Weak' %}{% endfilter %}";
            var T_GOOD = "{% filter escapejs %}{% trans 'Good' %}{% endfilter %}";
            var T_STRONG = "{% filter escapejs %}{% trans 'Strong' %}{% endfilter %}";
            var T_PW_POLICY = "{% filter escapejs %}{% trans 'Password must be at least 8 characters and include letters and numbers.' %}{% endfilter %}";
            var T_PW_MISMATCH = "{% filter escapejs %}{% trans 'Passwords do not match.' %}{% endfilter %}";
            var T_ACCEPT_TERMS = "{% filter escapejs %}{% trans 'Please accept Terms and Privacy Policy.' %}{% endfilter %}";
            var form = document.getElementById('registerForm');
            if (!form) return;
            form.addEventListener('submit', function(e){
              var p1 = document.getElementById('password').value;
              var p2 = document.getElementById('password2').value;
              var re = new RegExp('^(?=.*[A-Za-z])(?=.*[0-9]).{8,}$');
              if (!re.test(p1)) {
                e.preventDefault();
                alert(T_PW_POLICY);
                return false;
              }
              if (p1 !== p2) {
                e.preventDefault();
                alert(T_PW_MISMATCH);
                return false;
              }
              var terms = document.getElementById('acceptTerms');
              if (!terms || !terms.checked) {
                e.preventDefault();
                alert(T_ACCEPT_TERMS);
                return false;
              }
            });

            // Toggle password visibility
            function setupToggle(btnId, inputId, iconId) {
              var btn = document.getElementById(btnId);
              if (!btn) return;
              var input = document.getElementById(inputId);
              var icon = document.getElementById(iconId);
              btn.addEventListener('click', function(){
                var isPassword = input.getAttribute('type') === 'password';
                input.setAttribute('type', isPassword ? 'text' : 'password');
                if (isPassword) { icon.classList.remove('fa-eye'); icon.classList.add('fa-eye-slash'); }
                else { icon.classList.add('fa-eye'); icon.classList.remove('fa-eye-slash'); }
              });
            }
            setupToggle('togglePassword', 'password', 'eye');
            setupToggle('togglePassword2', 'password2', 'eye2');

            // Password strength meter
            var pwInput = document.getElementById('password');
            var bars = document.querySelectorAll('.pw-bar');
            var help = document.getElementById('pwHelp');
            function scorePassword(p){
              var score = 0;
              if (!p) return 0;
              if (p.length >= 8) score++;
              if (/[a-z]/.test(p)) score++;
              if (/[A-Z]/.test(p)) score++;
              if (/[0-9]/.test(p)) score++;
              if (/[^A-Za-z0-9]/.test(p)) score++;
              return Math.min(score, 5);
            }
            function renderStrength(s){
              bars.forEach(function(b){ b.className = 'pw-bar h-1 bg-gray-600 rounded-full flex-1'; });
              if (s <= 1) { bars[0].classList.add('bg-red-500'); help.textContent = T_VERY_WEAK; }
              else if (s === 2) { bars[0].classList.add('bg-yellow-500'); bars[1].classList.add('bg-yellow-500'); help.textContent = T_WEAK; }
              else if (s === 3) { bars[0].classList.add('bg-yellow-500'); bars[1].classList.add('bg-yellow-500'); bars[2].classList.add('bg-yellow-500'); help.textContent = T_GOOD; }
              else { bars.forEach(function(b){ b.classList.add('bg-green-500'); }); help.textContent = T_STRONG; }
            }
            if (pwInput) {
              pwInput.addEventListener('input', function(){ renderStrength(scorePassword(pwInput.value)); });
            }
          })();
        </script>
        <div class="auth-footer">
          {% trans "Already have an account?" %} <a href="{% url 'login' %}" class="auth-link">{% trans "Sign in" %}</a>
        </div>
        <div class="auth-footer">
          <a href="/" class="auth-link">{% trans "Back to Home" %}</a>
        </div>
      </div>
    </div>
  </main>
 </div>
{% endblock %}


